<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DIA GMDF JSON Builder & Approval Tracker</title>
<style>
  :root{--bg:#f7fbff;--card:#ffffff;--muted:#475569;--accent:#0ea5e9;--accent-2:#60a5fa;--border:#e6eef8;--ok:#16a34a;--danger:#ef4444;}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;padding:22px;color:#0f172a;}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:20px;margin:0;color:#0b1220}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 440px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(6,30,63,0.04)}
  label{display:block;font-weight:600;font-size:13px;color:#0b1220;margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #dbeafe;border-radius:8px;font-size:13px;color:#0b1220;background:#fff}
  textarea{min-height:80px;font-family:monospace}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;border:1px solid var(--border);color:#0b1220}
  .muted{color:var(--muted);font-size:13px}
  pre.output{background:#0b1220;color:#d6e0ff;padding:12px;border-radius:10px;min-height:160px;overflow:auto;font-size:12px}
  .small{font-size:12px;color:var(--muted)}
  .filters{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:8px;border-bottom:1px solid #eef6fc;text-align:left}
  th{background:#ecfeff;font-weight:700;font-size:12px}
  .status{padding:4px 8px;border-radius:999px;color:#fff;font-size:11px}
  .status.Pending{background:#f59e0b}
  .status.Approved{background:var(--ok)}
  .status.Rejected{background:#ef4444}
  .pagination{display:flex;gap:6px;align-items:center;margin-top:8px}
  .pagebtn{padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .smaller{font-size:11px;color:#334155}
  .info{color:var(--accent-2);margin-left:6px;cursor:help}
  .required{color:#ef4444;margin-left:6px;font-weight:700}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:#fff;padding:18px;border-radius:10px;width:520px;box-shadow:0 18px 40px rgba(2,6,23,0.3)}
  .row-between{display:flex;justify-content:space-between;align-items:center}
  .note{background:#f0f9ff;border:1px solid #e0f2fe;padding:8px;border-radius:8px;font-size:12px;color:#034f84}
  .inline{display:inline-block;margin-right:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>DIA GMDF — JSON Builder & Approval Tracker</h1>
      <div class="subtitle">Persistent approvals, mandatory fields, approve/reject actions</div>
    </div>
    <div class="small muted">TCS Support team • DIA-GMDF (Full Loads Script Builder)</div>
  </header>

  <div class="grid cols-2">
    <div class="card">
      <div class="row-between"><strong>GMDF Script Builder</strong><span class="small muted">Select script type and fill required fields</span></div>
      <div style="height:10px"></div>
      <label for="scriptType">Select Script Type</label>
      <select id="scriptType">
        <option value="dmsRaw">DMS to RAW</option>
        <option value="recalc">Recalculation</option>
        <option value="recalcBackup">Recalculation with Backup ID</option>
        <option value="dmsTask">DMS Task Start/Stop</option>
        <option value="refine">Refine Load</option>
        <option value="conform">Conform Load</option>
        <option value="conformTable">Conform load with Table</option>
        <option value="restore">Full Restore</option>
        <option value="refineConform">Refine + Conform Load</option>
        <option value="datamart">Datamart Load</option>
        <option value="datamartEntity">Datamart with ETL Entity</option>
      </select>
      <div id="dynamicFields" style="margin-top:12px"></div>
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button class="btn" id="genBtn">Generate JSON</button>
        <button class="btn ghost" id="copyBtn">Copy JSON</button>
        <button class="btn ghost" id="reqBtn">Request Approval</button>
        <div style="margin-left:auto" class="small muted">Workers: <input id="workers_global" type="number" min="1" value="10" style="width:80px;margin-left:8px;padding:6px;border-radius:6px;border:1px solid #dbeafe"/></div>
      </div>
      <div style="margin-top:10px" class="note small muted">Fields marked <span class="required">*</span> are mandatory. Missing values are stored/displayed as <strong>NA</strong>.</div>
    </div>

    <div class="card">
      <div class="row-between"><strong>Generated JSON</strong><div class="small muted">Preview & download</div></div>
      <pre id="output" class="output">{ }</pre>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="small muted">Copy or download the JSON to run in Lambda</div>
        <div>
          <button class="btn ghost" id="downloadBtn">Download JSON</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <div class="row-between">
      <strong>Approval Requests</strong>
      <div class="filters">
        <input id="searchInput" type="text" placeholder="Search Chain/Source/Mode/Ticket" style="padding:8px;border-radius:8px;border:1px solid #e6eef8;width:360px"/>
        <input id="filterDate" type="date" style="padding:8px;border-radius:8px;border:1px solid #e6eef8"/>
        <select id="statusFilter" style="padding:8px;border-radius:8px;border:1px solid #e6eef8"><option value="">All Status</option><option>Pending</option><option>Approved</option><option>Rejected</option></select>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="table-container">
      <table id="approvalTable">
        <thead><tr><th>Req ID</th><th>Requestor</th><th>Approver</th><th>Chain</th><th>Src ID</th><th>Mode</th><th>Step</th><th>Ticket</th><th>Reason</th><th>Requested Time</th><th>Approval Time</th><th>Status</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="row-between"><strong>Request Approval</strong><button id="closeModal" class="btn ghost">Close</button></div>
    <div style="height:8px"></div>
    <div>
      <label>Requestor Name <span class="required">*</span></label><input id="modalRequestor" type="text" placeholder="Your name">
      <label style="margin-top:8px">Approver Name <span class="required">*</span></label><input id="modalApprover" type="text" placeholder="Approver name">
      <label style="margin-top:8px">Reference Ticket <span class="required">*</span></label><input id="modalTicket" type="text" placeholder="e.g. INC-12345">
      <label style="margin-top:8px">Reason <span class="required">*</span></label><textarea id="modalReason" placeholder="Short reason for request"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="submitRequest" class="btn">Submit Request</button>
        <button id="cancelRequest" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// helpers and persistence keys
const byId = id => document.getElementById(id);
const RESET_DAYS = 90; // auto-export/reset
const PAGE_SIZE = 8;

let approvals = [];
let currentPage = 1;

// GitHub repo info
const REPO_OWNER = "fareed-007";
const REPO_NAME = "dia-gmdf-webapp-tool";
const FILE_PATH = "Export_Data/approvals.json";
const BRANCH = "main";
const TOKEN = "<YOUR_APP_TOKEN>"; // replace with your PAT stored in secret for testing

// helper functions
function na(v) { return v === undefined || v === null || v === '' ? 'NA' : v; }

// fetch approvals.json from GitHub
async function loadApprovals() {
  try {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`;
    const res = await fetch(url, {
      headers: { Authorization: `token ${TOKEN}` }
    });
    if (!res.ok) throw new Error('Failed to fetch approvals.json');
    const data = await res.json();
    approvals = JSON.parse(atob(data.content));
    renderTable();
  } catch (err) {
    console.log('Could not load approvals.json, starting empty:', err.message);
    approvals = [];
  }
}

// push updated approvals.json to GitHub
async function updateApprovalsJSON() {
  try {
    const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;
    const getRes = await fetch(url, { headers: { Authorization: `token ${TOKEN}` } });
    const getData = await getRes.json();
    const sha = getData.sha;

    const body = {
      message: `Update approvals ${new Date().toISOString()}`,
      content: btoa(JSON.stringify(approvals, null, 2)),
      sha: sha,
      branch: BRANCH
    };

    await fetch(url, {
      method: "PUT",
      headers: { Authorization: `token ${TOKEN}` },
      body: JSON.stringify(body)
    });
  } catch (err) {
    console.error('Failed to update approvals.json:', err);
  }
}

// export CSV
function exportCSV() {
  if (!approvals.length) return;
  const rows = [['Req ID','Requestor','Approver','Chain','Src','Mode','Step','Ticket','Reason','Requested Time','Approval Time','Status']];
  approvals.forEach(a => {
    rows.push([a.id, a.requestor, a.approver, a.chain, a.src, a.mode, a.step||'NA', a.ticket, a.reason, a.requestedTime, a.approvalTime||'', a.status]);
  });
  const csv = rows.map(r => r.map(c => `"${String(c??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `approvals_export_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// auto-export/reset every RESET_DAYS
async function autoExportReset() {
  const lastReset = localStorage.getItem('LAST_RESET') || new Date().toISOString();
  const diffDays = (Date.now() - new Date(lastReset)) / (1000*60*60*24);
  if (approvals.length >= 1000 || diffDays >= RESET_DAYS) {
    exportCSV();
    approvals = [];
    await updateApprovalsJSON();
    localStorage.setItem('LAST_RESET', new Date().toISOString());
    alert('Approvals exported and reset!');
    renderTable();
  }
}

// render table with filters, pagination
function renderTable() {
  const tbody = byId('approvalTable').querySelector('tbody');
  tbody.innerHTML = '';
  const search = byId('searchInput').value.toLowerCase();
  const dateFilter = byId('filterDate').value;
  const statusFilter = byId('statusFilter').value;
  const filtered = approvals.filter(a => {
    const matchSearch = (a.chain+' '+a.src+' '+a.mode+' '+(a.ticket||'')+' '+a.requestor+' '+a.approver).toLowerCase().includes(search);
    const matchDate = dateFilter ? new Date(a.requestedTime).toISOString().split('T')[0]===dateFilter : true;
    const matchStatus = statusFilter ? a.status===statusFilter : true;
    return matchSearch && matchDate && matchStatus;
  });

  const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
  if (currentPage > totalPages) currentPage = 1;
  const start = (currentPage-1)*PAGE_SIZE;
  const pageData = filtered.slice(start, start+PAGE_SIZE);

  pageData.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.id}</td>
      <td>${a.requestor}</td>
      <td>${a.approver}</td>
      <td>${a.chain}</td>
      <td>${a.src}</td>
      <td>${a.mode}</td>
      <td>${a.step||'NA'}</td>
      <td>${a.ticket}</td>
      <td>${a.reason}</td>
      <td>${new Date(a.requestedTime).toLocaleString()}</td>
      <td>${a.approvalTime ? new Date(a.approvalTime).toLocaleString() : ''}</td>
      <td><span class="status ${a.status}">${a.status}</span></td>
      <td>
        <button class="pagebtn" onclick="approveRequest('${a.id}')">Approve</button>
        <button class="pagebtn" onclick="rejectRequest('${a.id}')">Reject</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // pagination
  const pag = byId('pagination'); pag.innerHTML='';
  for(let i=1;i<=totalPages;i++){
    const b=document.createElement('button'); b.textContent=i; b.className='pagebtn';
    if(i===currentPage) b.style.background='#eef2ff';
    b.onclick = ()=>{ currentPage=i; renderTable(); };
    pag.appendChild(b);
  }
}

// approve/reject functions
async function approveRequest(id){
  const idx = approvals.findIndex(a=>a.id===id);
  if(idx>-1){ 
    approvals[idx].status='Approved'; 
    approvals[idx].approvalTime = new Date().toISOString(); 
    await updateApprovalsJSON(); 
    renderTable(); 
  }
}
async function rejectRequest(id){
  const idx = approvals.findIndex(a=>a.id===id);
  if(idx>-1){
    const reason = prompt('Reason for rejection (optional)');
    approvals[idx].status='Rejected';
    approvals[idx].approvalTime = new Date().toISOString();
    if(reason) approvals[idx].rejectReason = reason;
    await updateApprovalsJSON();
    renderTable();
  }
}

// modal submit
byId('submitRequest').addEventListener('click', async ()=>{
  const req = byId('modalRequestor').value.trim();
  const app = byId('modalApprover').value.trim();
  const ticket = byId('modalTicket').value.trim();
  const reason = byId('modalReason').value.trim();
  if(!req || !app || !ticket || !reason){ alert('Fill all required fields'); return; }

  const payload = JSON.parse(byId('output').textContent || '{}');
  const id = 'REQ-'+Math.floor(Math.random()*900000+100000);
  const requestedTime = new Date().toISOString();
  const record = {
    id, requestor:req, approver:app, chain: payload.chain||'NA', src: payload.src||'NA', mode: payload.mode||'NA',
    step: payload.step||'NA', ticket, reason, requestedTime, approvalTime:null, status:'Pending'
  };
  approvals.unshift(record);
  await updateApprovalsJSON();
  renderTable();
  alert('Request submitted: '+id);
  modal.style.display='none';

  // check auto-export
  await autoExportReset();
});

// filters
byId('searchInput').addEventListener('input', ()=>{ currentPage=1; renderTable(); });
byId('filterDate').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
byId('statusFilter').addEventListener('change', ()=>{ currentPage=1; renderTable(); });

// initial load
loadApprovals();
</script>
</body>
</html>



