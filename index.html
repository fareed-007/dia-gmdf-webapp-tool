<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DIA GMDF JSON Builder & Approval Tracker</title>
<style>
  :root{--bg:#f7fbff;--card:#ffffff;--muted:#475569;--accent:#0ea5e9;--accent-2:#60a5fa;--border:#e6eef8;--ok:#16a34a;--danger:#ef4444;}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;padding:22px;color:#0f172a;}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:20px;margin:0;color:#0b1220}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 440px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(6,30,63,0.04)}
  label{display:block;font-weight:600;font-size:13px;color:#0b1220;margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #dbeafe;border-radius:8px;font-size:13px;color:#0b1220;background:#fff}
  textarea{min-height:80px;font-family:monospace}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;border:1px solid var(--border);color:#0b1220}
  .muted{color:var(--muted);font-size:13px}
  pre.output{background:#0b1220;color:#d6e0ff;padding:12px;border-radius:10px;min-height:160px;overflow:auto;font-size:12px}
  .small{font-size:12px;color:var(--muted)}
  .row-between{display:flex;justify-content:space-between;align-items:center}
  .required{color:#ef4444;margin-left:6px;font-weight:700}

  /* AI Bot box */
  #aiBotBox{margin-top:20px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 4px 12px rgba(6,30,63,0.05);display:flex;flex-direction:column;gap:8px}
  #aiBotMessages{height:160px;overflow-y:auto;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-size:13px;color:#0f172a}
  #aiBotInput{flex:1;padding:8px;border:1px solid #dbeafe;border-radius:8px;font-size:13px}
  #aiBotControls{display:flex;gap:8px}
  #aiBotControls button{background:var(--accent);color:#fff;padding:8px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>DIA GMDF – JSON Builder for Full Load Activities</h1>
        <div class="subtitle">Build, Validate, and Automate Scripts generator – All in One Place.</div>
      </div>
      <div class="small muted">TCS - DIA GMDF Team • Prepare your script here</div>
    </header>

    <div class="grid cols-2">
      <div class="card">
        <div class="row-between"><strong>Script Builder</strong><span class="small muted">Select script type and fill required fields</span></div>
        <div style="height:10px"></div>
        <label for="scriptType">Select Script Type</label>
        <select id="scriptType">
          <option value="dmsRaw">DMS to RAW</option>
          <option value="recalc">Recalculation</option>
          <option value="recalcBackup">Recalculation with Backup ID</option>
          <option value="dmsTask">DMS Task Start/Stop</option>
          <option value="refine">Refine Load</option>
          <option value="conform">Conform Load</option>
          <option value="conformTable">Conform Load with Tables</option>
		  <option value="conformEntity">Conform with ETL Sessions</option>
          <option value="restore">Full Restore</option>
          <option value="refineConform">Refine + Conform Load</option>
          <option value="datamart">Datamart Load</option>
          <option value="datamartEntity">Datamart with ETL Sessions</option>
        </select>

        <div id="dynamicFields" style="margin-top:12px"></div>

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <button class="btn" id="genBtn">Generate JSON</button>
          <button class="btn ghost" id="copyBtn">Copy JSON</button>
        </div>
      </div>

      <div class="card">
        <div class="row-between"><strong>Generated JSON</strong><div class="small muted">Preview & download</div></div>
        <pre id="output" class="output">{ }</pre>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small muted">Copy or download the JSON to run in Lambda</div>
          <div>
            <button class="btn ghost" id="downloadBtn">Download JSON</button>
          </div>
        </div>
      </div>
    </div>
   <div style="height:12px"></div>	
<script>
let aiData = [];

async function loadAIData() {
  const url = 'https://raw.githubusercontent.com/fareed-007/dia-gmdf-webapp-tool/main/Export_File/Data_for_AI-Model.xlsx';
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: 'array' });
  const sheetName = workbook.SheetNames[0];
  aiData = XLSX.utils.sheet_to_json(workbook.Sheets[Sheet1]);
  console.log('AI Data Loaded:', aiData);
}

// Prefilled repo path to use
const PREFILL_OWNER = 'fareed-007';
const PREFILL_REPO = 'dia-gmdf-webapp-tool';
const PREFILL_DIR = 'Export_Data';
const MASTER_FILENAME = 'approvals_master.json'; // central file that holds current requests
const STORAGE_KEY='dia_approvals_shared_v1';
const SETTINGS_KEY='dia_approvals_shared_settings_v1';
const RESET_KEY='dia_approvals_last_reset_v1';
const RESET_DAYS=90;

const byId=id=>document.getElementById(id);
let approvals = []; // will be loaded from repo master file if available
let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}') || {};
let currentPage=1; const pageSize=8;

// Initialize settings with prefill if empty
(function initSettings(){
  if(!settings.owner) settings.owner = PREFILL_OWNER;
  if(!settings.repo) settings.repo = PREFILL_REPO;
  if(!settings.dir) settings.dir = PREFILL_DIR;
  if(!settings.branch) settings.branch = 'main';
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
})();

let aiData = [];

// Load Excel from GitHub
async function loadAIData() {
  const url = 'https://raw.githubusercontent.com/fareed-007/dia-gmdf-webapp-tool/main/Export_File/Data_for_AI-Model.xlsx';
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: 'array' });
  const Sheet1 = workbook.SheetNames[0];
  aiData = XLSX.utils.sheet_to_json(workbook.Sheets[Sheet1]);
  console.log('AI Data Loaded:', aiData);
}

// Call this on page load
window.onload = () => {
  loadAIData();
};

// UI helpers
function addField(label,id,multi=false, opts){ const container=byId('dynamicFields'); const wrap=document.createElement('div'); wrap.style.marginBottom='8px'; const lab=document.createElement('label'); lab.textContent=label + (opts && opts.required? ' ':''); if(opts && opts.required){ const star=document.createElement('span'); star.className='required'; star.textContent='*'; lab.appendChild(star); } lab.htmlFor=id; wrap.appendChild(lab); let field; if(multi){ field=document.createElement('textarea'); } else if(opts && opts.type==='select'){ field=document.createElement('select'); opts.choices.forEach(ch=>{ const o=document.createElement('option'); o.value=ch; o.textContent=ch; field.appendChild(o); }); } else { field=document.createElement('input'); field.type=(opts && opts.inputType)?opts.inputType:'text'; } field.id=id; wrap.appendChild(field); container.appendChild(wrap); if(opts && opts.info){ const info=document.createElement('span'); info.className='info'; info.textContent=' ℹ️'; info.title=opts.info; lab.appendChild(info); } return field; }

function renderFields(){
  const type=byId('scriptType').value;
  const c=byId('dynamicFields');
  c.innerHTML='';
  const modeChoices=['delta','full','full_restore'];

  if(type==='dmsRaw'){
    addField('Bucket Name','bucket',false);
    addField('Key paths (comma separated)','key',true);

  } else if(type==='recalc'){
    addField('Chain Name','chain',false,{required:true});
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('Table Name','table',false);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});

  } else if(type==='recalcBackup'){
    addField('Chain Name','chain',false,{required:true});
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('Tables with backup_load_id (JSON array)','tables',true,{info:'{\n  "table_name": "<TABLE_NAME>",\n  "backup_load_id": "jr_<loadid>"\n}'});
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});

  } else if(type==='dmsTask'){
    addField('Action (start/stop)','action',false,{required:true});
    addField('Task Names (comma separated)','tasks',true,{required:true,info:'Provide DMS task names comma separated'});

  } else if(type==='refine'){
    addField('Chain Name','chain',false,{required:true});
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('Tables (comma separated)','tables',true);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});

  } else if(type==='conform'){
    addField('Chain Name','chain',false,{required:true});
    addField('Parent ETL Job','parent',false);
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});
    addField('Conform Sessions (comma separated)','sessions',true,{info:'Provide session names as comma separated values'});
    addField('Free Threads','free_threads',false,{type:'checkbox'});
    addField('Check Dependency','check_dependency',false,{type:'checkbox'});

  } else if(type==='conformTable'){
    addField('Chain Name','chain',false,{required:true});
    addField('Parent ETL Job','parent',false);
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('Tables (comma separated)','tables',true);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});
	
  } else if(type==='conformEntity'){
    addField('Chain Name','chain',false,{required:true});
    addField('Parent ETL Job','parent',false);
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('ETL Entities (comma separated)','sessions',true);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});	

  } else if(type==='restore'){
    addField('Chain Name','chain',false,{required:true});
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('DMS Task(s) (comma separated)','tasks',true,{required:true});
    addField('Step (1 or 2)','step',false,{type:'select',choices:['1','2'],required:true});
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});

  } else if(type==='refineConform'){
    addField('Chain Name','chain',false,{required:true});
    addField('Source ID','src',false,{required:true,inputType:'number'});
    addField('Parent ETL Job (Conform)','parent',false);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});

  } else if(type==='datamart'){
    addField('Chain Name','chain',false,{required:true});
    addField('Parent ETL Job','parent',false);
    addField('Application Code','app',false);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});

  } else if(type==='datamartEntity'){
    addField('Chain Name','chain',false,{required:true});
    addField('Parent ETL Job','parent',false);
    addField('Application Code','app',false);
    addField('ETL Entities (comma separated)','entities',true);
    addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true});
    addField('Workers','workers',false,{required:true,inputType:'number'});
  }
}

byId('scriptType').addEventListener('change', renderFields); renderFields();

// After renderFields()
function attachAutofill() {
  const srcInput = byId('src');
  if(!srcInput) return;

  srcInput.addEventListener('change', () => {
    const srcVal = srcInput.value.trim();
    if(!srcVal || !aiData) return;

    // Find matching row in Excel
    const match = aiData.find(r => String(r["Source ID"]) === srcVal);
    if(match) {
      if(byId('chain')) byId('chain').value = match["Conform Job"] || '';
      if(byId('parent')) byId('parent').value = match["Datamart Job"] || '';
      if(byId('sessions')) byId('sessions').value = match["Conform Sessions"] || '';
      if(byId('app')) byId('app').value = match["Application CD"] || '';
    }
  });
}

// Build payload (same as earlier)
function na(v){ return (v===undefined||v===null||v==='')? 'NA' : v; }
function buildPayload(){
  const type = byId('scriptType').value;
  const w = byId('workers')?.value || byId('workers_global')?.value || 'NA';
  try{
    if(type==='dmsRaw'){
      return {
        bucketName: na(byId('bucket')?.value),
        keys: byId('key')?.value ? byId('key').value.split(',').map(s=>s.trim()) : []
      };
    }

    if(type==='recalc'){
      return {
        launch:'manual',
        refine:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency: byId('check_dependency')?.checked || true,
              parent_etl_job:'edb_mq_dia_golden_copy',
              systems:[{ r_src_id: String(na(byId('src')?.value)) || 0, tables:[{ table_name: na(byId('table')?.value) }] }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        }
      };
    }

    if(type==='recalcBackup'){
      let tablesTxt = byId('tables')?.value || '[]';
      let tablesArr = [];
      try{ tablesArr = JSON.parse(tablesTxt); } catch(e){ tablesArr = []; }
      return {
        launch:'manual',
        refine:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency: byId('check_dependency')?.checked || true,
              parent_etl_job:'edb_mq_dia_golden_copy',
              systems:[{ r_src_id: String(na(byId('src')?.value)) || 0, tables: tablesArr }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        }
      };
    }

    if(type==='dmsTask'){
      const action = na(byId('action')?.value);
      const list = byId('tasks')?.value ? byId('tasks').value.split(',').map(s=>s.trim()) : [];
      return {
        dms:{
          action: action,
          dms_object:'task',
          mode:'default',
          ...(action==='start'?{ start_type:'resume' }:{}),
          input_list: list
        }
      };
    }

    if(type==='refine'){
      return {
        launch:'manual',
        refine:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency: byId('check_dependency')?.checked || true,
              parent_etl_job:'edb_mq_dia_golden_copy',
              systems:[{ r_src_id: String(na(byId('src')?.value)) || 0, tables: byId('tables')?.value ? byId('tables').value.split(',').map(s=>s.trim()) : [] }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||10,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        }
      };
    }

    if(type==='conform'){
      const sessions = byId('sessions')?.value ? byId('sessions').value.split(',').map(s=>s.trim()) : [];
      return {
        launch:'manual',
        conform:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency: byId('check_dependency')?.checked || false,
              parent_etl_job: na(byId('parent')?.value),
              systems:[{
                r_src_id: String(na(byId('src')?.value)) || 0,
                sessions: sessions
              }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || false
            }]
          }]
        }
      };
    }

    if(type==='conformTable'){
      return {
        launch:'manual',
        conform:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              parent_etl_job: na(byId('parent')?.value),
              systems:[{
                r_src_id: String(na(byId('src')?.value)) || 0,
                tables: byId('tables')?.value ? byId('tables').value.split(',').map(s=>s.trim()) : []
              }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || false
            }]
          }]
        }
      };
    }

	if(type==='conformEntity'){
	  const sessions = byId('sessions')?.value ? byId('sessions').value.split(',').map(s=>s.trim()) : [];
	  return {
		launch:'manual',
		conform:{
		  sequential_jobs:[{
			parallel_jobs:[{
			  chain_name: na(byId('chain')?.value),
			  check_dependency: byId('check_dependency')?.checked || false,
			  parent_etl_job: na(byId('parent')?.value),
			  systems:[{
				r_src_id: String(na(byId('src')?.value)) || 0,
				etl_entity: sessions // <-- Added Conform Sessions here
			  }],
			  mode: na(byId('mode')?.value),
			  n_workers: Number(w)||40,
			  free_threads: byId('free_threads')?.checked || false
			}]
		  }]
		}
	  };
	}

    if(type==='restore'){
      return {
        launch:'manual',
        refine:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency:false,
              parent_etl_job:'edb_mq_dia_golden_copy',
              systems:[{
                r_src_id: String(na(byId('src')?.value)) || 0,
                dms_tasks: byId('tasks')?.value ? byId('tasks').value.split(',').map(s=>s.trim()) : []
              }],
              mode: na(byId('mode')?.value),
              step: na(byId('step')?.value),
              n_workers: Number(w)||10,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        }
      };
    }

    if(type==='refineConform'){
      return {
        launch:'batch',
        refine:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency:true,
              parent_etl_job:'edb_mq_dia_golden_copy',
              systems:[{ r_src_id: String(na(byId('src')?.value)) || 0 }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        },
        conform:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency: byId('check_dependency')?.checked || false,
              parent_etl_job: na(byId('parent')?.value),
              systems:[{
                r_src_id: String(na(byId('src')?.value)) || 0,
                sessions: byId('sessions')?.value ? byId('sessions').value.split(',').map(s=>s.trim()) : []
              }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || false
            }]
          }]
        }
      };
    }

    if(type==='datamart'){
      return {
        launch:'manual',
        datamart:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency:true,
              parent_etl_job: na(byId('parent')?.value),
              systems:[{ applctn_cd: na(byId('app')?.value) }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||10,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        }
      };
    }

    if(type==='datamartEntity'){
      const ent = byId('entities')?.value ? byId('entities').value.split(',').map(s=>s.trim()) : [];
      return {
        launch:'manual',
        datamart:{
          sequential_jobs:[{
            parallel_jobs:[{
              chain_name: na(byId('chain')?.value),
              check_dependency:true,
              parent_etl_job: na(byId('parent')?.value),
              systems:[{
                applctn_cd: na(byId('app')?.value),
                etl_entity: ent,
                dependencies: []
              }],
              mode: na(byId('mode')?.value),
              n_workers: Number(w)||40,
              free_threads: byId('free_threads')?.checked || true
            }]
          }]
        }
      };
    }

  }catch(e){
    return { error: e.message };
  }
}

// Validate Script using AI Excel Data
function validateWithAI(payload){
  const errors=[];
  if(payload.conform){
    payload.conform.sequential_jobs.forEach(job=>{
      job.parallel_jobs.forEach(pj=>{
        const srcVal = pj.systems[0].r_src_id;
        if(!aiData.some(r=>String(r['Source ID']).trim()===srcVal)) errors.push(`Source ID "${srcVal}" not found`);
        pj.systems[0].etl_entity.forEach(sess=>{
          if(!aiData.some(r=>String(r['entity']).trim()===sess)) errors.push(`Conform Session "${sess}" not found`);
        });
        if(pj.parent_etl_job && !aiData.some(r=>String(r['Conform Job']).trim()===pj.parent_etl_job)) errors.push(`Parent ETL Job "${pj.parent_etl_job}" not found`);
      });
    });
  }
  if(errors.length){
    alert('AI Validation Errors:\n'+errors.join('\n'));
    return false;
  }
  return true;
}

function submitScript(){
  const payload = buildPayload();
  if(!validateWithAI(payload)) return; // stops if errors
  byId('output').innerText = JSON.stringify(payload,null,2);
}

function askAIBot(){
  const input = byId('aiBotInput').value.trim().toLowerCase();
  const messages = byId('aiBotMessages');
  if(!input) return;
  let response = 'No match found.';
  aiData.forEach(row=>{
    const rowStr = Object.values(row).join(' ').toLowerCase();
    if(rowStr.includes(input)) response = JSON.stringify(row,null,2);
  });
  messages.innerHTML += `<div><b>You:</b> ${input}</div>`;
  messages.innerHTML += `<div><b>Bot:</b> <pre>${response}</pre></div>`;
  messages.scrollTop = messages.scrollHeight;
  byId('aiBotInput').value = '';
}

// display & copy
byId('genBtn').addEventListener('click', ()=>{ const p = buildPayload(); byId('output').textContent = JSON.stringify(p,null,2); });
byId('copyBtn').addEventListener('click', ()=>{ const txt = byId('output').textContent; if(!txt){ alert('Nothing to copy'); return;} navigator.clipboard.writeText(txt).then(()=>alert('JSON copied to clipboard')); });
byId('downloadBtn').addEventListener('click', ()=>{ const txt = byId('output').textContent || ''; const blob = new Blob([txt], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payload.json'; a.click(); URL.revokeObjectURL(a.href); });

// Modal & approval submission
const modal = byId('modalBackdrop');
byId('reqBtn').addEventListener('click', ()=>{ modal.style.display='flex'; byId('modalRequestor').value=''; byId('modalApprover').value=''; byId('modalTicket').value=''; byId('modalReason').value=''; });
byId('closeModal').addEventListener('click', ()=> modal.style.display='none');
byId('cancelRequest').addEventListener('click', ()=> modal.style.display='none');

// GitHub API helpers
function ghHeaders(){ return { 'Authorization': 'token '+(settings.token||''), 'Accept': 'application/vnd.github.v3+json' }; }
async function ghGetFile(path){
  const owner = settings.owner || PREFILL_OWNER;
  const repo = settings.repo || PREFILL_REPO;
  const branch = settings.branch || 'main';
  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
  const res = await fetch(url, { headers: ghHeaders() });
  if(res.status===404) return null;
  if(!res.ok) throw new Error('GitHub GET failed: '+(await res.text()));
  const j = await res.json();
  return j; // contains content (base64), sha, etc
}
async function ghPutFile(path, contentBase64, message, sha=null){
  const owner = settings.owner || PREFILL_OWNER;
  const repo = settings.repo || PREFILL_REPO;
  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: contentBase64, branch: settings.branch || 'main' };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers: ghHeaders(), body: JSON.stringify(body) });
  if(!res.ok) throw new Error('GitHub PUT failed: '+(await res.text()));
  return await res.json();
}

// load master approvals from repo into app (shared state)
async function loadApprovalsFromRepo(){
  try{
    const path = (settings.dir || PREFILL_DIR).replace(/\/+$/,'') + '/' + MASTER_FILENAME;
    const file = await ghGetFile(path);
    if(!file){ // create empty master file
      approvals = [];
      await saveApprovalsToRepo(approvals, 'Create master approvals file');
      renderTable();
      return;
    }
    const raw = atob(file.content.replace(/\n/g,''));
    approvals = JSON.parse(raw || '[]');
    saveLocal(); renderTable();
  }catch(err){
    console.warn('Could not load approvals from repo, falling back to localStorage. Error:', err.message);
    // fallback to local stored copy if exists
    const local = localStorage.getItem(STORAGE_KEY);
    approvals = local ? JSON.parse(local) : [];
    renderTable();
  }
}

// save approvals to repo MASTER file (overwrites)
async function saveApprovalsToRepo(arr, message){
  if(!settings.token){ throw new Error('No GitHub token in Settings'); }
  const path = (settings.dir || PREFILL_DIR).replace(/\/+$/,'') + '/' + MASTER_FILENAME;
  // get sha if exists
  let sha = null;
  try{ const existing = await ghGetFile(path); if(existing) sha = existing.sha; }catch(e){ /*ignore*/ }
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(arr, null, 2))));
  await ghPutFile(path, content, message || 'Update approvals master', sha);
}

// Manual export button not shown in UI; auto-run on load and provide a button via console if needed
// GitHub file PUT wrapper reused above

// Load on start: try to load master from repo, else fallback to local
(async function start(){
  // load settings from localStorage if present
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); if(s) settings = s;
  // Try to load approvals from repo master file (shared state)
  await loadApprovalsFromRepo();
  // run auto export if due
  await autoExportRunner();
  // attach filters and events
  byId('searchInput').addEventListener('input', ()=>{ currentPage=1; renderTable(); });
  byId('filterDate').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
  byId('statusFilter').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
  byId('workers_global').addEventListener('change', ()=>{ if(byId('workers')) byId('workers').value = byId('workers_global').value; });
})();

</script>
</body>
</html>
