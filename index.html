<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DIA GMDF JSON Builder & Approval Tracker</title>
<style>
  :root{--bg:#f7fbff;--card:#ffffff;--muted:#475569;--accent:#0ea5e9;--accent-2:#60a5fa;--border:#e6eef8;--ok:#16a34a;--danger:#ef4444;}
  body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;padding:22px;color:#0f172a;}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:20px;margin:0;color:#0b1220}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 440px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(6,30,63,0.04)}
  label{display:block;font-weight:600;font-size:13px;color:#0b1220;margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #dbeafe;border-radius:8px;font-size:13px;color:#0b1220;background:#fff}
  textarea{min-height:80px;font-family:monospace}
  .row{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:#fff;border:1px solid var(--border);color:#0b1220}
  .muted{color:var(--muted);font-size:13px}
  pre.output{background:#0b1220;color:#d6e0ff;padding:12px;border-radius:10px;min-height:160px;overflow:auto;font-size:12px}
  .small{font-size:12px;color:var(--muted)}
  .filters{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:8px;border-bottom:1px solid #eef6fc;text-align:left}
  th{background:#ecfeff;font-weight:700;font-size:12px}
  .status{padding:4px 8px;border-radius:999px;color:#fff;font-size:11px}
  .status.Pending{background:#f59e0b}
  .status.Approved{background:var(--ok)}
  .status.Rejected{background:var(--danger)}
  .pagination{display:flex;gap:6px;align-items:center;margin-top:8px}
  .pagebtn{padding:6px 8px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .smaller{font-size:11px;color:#334155}
  .info{color:var(--accent-2);margin-left:6px;cursor:help}
  .required{color:#ef4444;margin-left:6px;font-weight:700}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:#fff;padding:18px;border-radius:10px;width:520px;box-shadow:0 18px 40px rgba(2,6,23,0.3)}
  .row-between{display:flex;justify-content:space-between;align-items:center}
  .note{background:#f0f9ff;border:1px solid #e0f2fe;padding:8px;border-radius:8px;font-size:12px;color:#034f84}
  .inline{display:inline-block;margin-right:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>DIA GMDF — JSON Builder & Approval Tracker</h1>
        <div class="subtitle">Persistent approvals, mandatory fields, approve/reject actions</div>
      </div>
      <div class="small muted">Team-ready • Shared storage via GitHub repo</div>
    </header>

    <div class="grid cols-2">
      <div class="card">
        <div class="row-between"><strong>Script Builder</strong><span class="small muted">Select script type and fill required fields</span></div>
        <div style="height:10px"></div>
        <label for="scriptType">Select Script Type</label>
        <select id="scriptType">
          <option value="dmsRaw">DMS to RAW</option>
          <option value="recalc">Recalculation</option>
          <option value="recalcBackup">Recalculation with Backup ID</option>
          <option value="dmsTask">DMS Task Start/Stop</option>
          <option value="refine">Refine Load</option>
          <option value="conform">Conform Load</option>
          <option value="conformTable">Conform load with Table</option>
          <option value="restore">Full Restore</option>
          <option value="refineConform">Refine + Conform Load</option>
          <option value="datamart">Datamart Load</option>
          <option value="datamartEntity">Datamart with ETL Entity</option>
        </select>

        <div id="dynamicFields" style="margin-top:12px"></div>

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <button class="btn" id="genBtn">Generate JSON</button>
          <button class="btn ghost" id="copyBtn">Copy JSON</button>
          <button class="btn ghost" id="reqBtn">Request Approval</button>
          <div style="margin-left:auto" class="small muted">Workers: <input id="workers_global" type="number" min="1" value="10" style="width:80px;margin-left:8px;padding:6px;border-radius:6px;border:1px solid #dbeafe"/></div>
        </div>

        <div style="margin-top:10px" class="note small muted">Fields marked <span class="required">*</span> are mandatory. Missing values are stored/displayed as <strong>NA</strong>.</div>
        <div style="margin-top:8px"><button class="btn ghost" id="openSettings">Settings</button> <span class="small muted"> (Settings prefilled for <strong>fareed-007/dia-gmdf-webapp-tool</strong>)</span></div>
      </div>

      <div class="card">
        <div class="row-between"><strong>Generated JSON</strong><div class="small muted">Preview & download</div></div>
        <pre id="output" class="output">{ }</pre>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small muted">Copy or download the JSON to run in Lambda</div>
          <div>
            <button class="btn ghost" id="downloadBtn">Download JSON</button>
          </div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="row-between">
        <strong>Approval Requests</strong>
        <div class="filters">
          <input id="searchInput" type="text" placeholder="Search Chain/Source/Mode/Ticket" style="padding:8px;border-radius:8px;border:1px solid #e6eef8;width:360px"/>
          <input id="filterDate" type="date" style="padding:8px;border-radius:8px;border:1px solid #e6eef8"/>
          <select id="statusFilter" style="padding:8px;border-radius:8px;border:1px solid #e6eef8"><option value="">All Status</option><option>Pending</option><option>Approved</option><option>Rejected</option></select>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="table-container">
        <table id="approvalTable">
          <thead><tr><th>Req ID</th><th>Requestor</th><th>Approver</th><th>Chain</th><th>Src ID</th><th>Mode</th><th>Step</th><th>Ticket</th><th>Reason</th><th>Requested Time</th><th>Approval Time</th><th>Status</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- Modal for Request Approval -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="row-between"><strong>Request Approval</strong><button id="closeModal" class="btn ghost">Close</button></div>
      <div style="height:8px"></div>
      <div>
        <label>Requestor Name <span class="required">*</span></label><input id="modalRequestor" type="text" placeholder="Your name">
        <label style="margin-top:8px">Approver Name <span class="required">*</span></label><input id="modalApprover" type="text" placeholder="Approver name">
        <label style="margin-top:8px">Reference Ticket <span class="required">*</span></label><input id="modalTicket" type="text" placeholder="e.g. INC-12345">
        <label style="margin-top:8px">Reason <span class="required">*</span></label><textarea id="modalReason" placeholder="Short reason for request"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="submitRequest" class="btn">Submit Request</button>
          <button id="cancelRequest" class="btn ghost">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal (prefilled) -->
  <div id="settingsBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="row-between"><strong>GitHub Export Settings</strong><button id="closeSettings" class="btn ghost">Close</button></div>
      <div style="height:8px"></div>
      <div>
        <div class="note">To enable shared app state across your team the app reads/writes a central file in this repo. Use a machine/service token (kept private) with <b>contents: write</b> on the target repo. The settings are stored only in browser localStorage.</div>
        <label style="margin-top:8px">Owner / Org</label><input id="ghOwner" type="text" value="fareed-007">
        <label style="margin-top:8px">Repository</label><input id="ghRepo" type="text" value="dia-gmdf-webapp-tool">
        <label style="margin-top:8px">Branch</label><input id="ghBranch" type="text" value="main">
        <label style="margin-top:8px">Directory</label><input id="ghDir" type="text" value="Export_Data">
        <label style="margin-top:8px">Personal Access Token (ghp_...)</label><input id="ghToken" type="text" placeholder="Paste token (contents: write)">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="saveSettings" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
// Prefilled repo path to use
const PREFILL_OWNER = 'fareed-007';
const PREFILL_REPO = 'dia-gmdf-webapp-tool';
const PREFILL_DIR = 'Export_Data';
const MASTER_FILENAME = 'approvals_master.json'; // central file that holds current requests
const STORAGE_KEY='dia_approvals_shared_v1';
const SETTINGS_KEY='dia_approvals_shared_settings_v1';
const RESET_KEY='dia_approvals_last_reset_v1';
const RESET_DAYS=90;

const byId=id=>document.getElementById(id);
let approvals = []; // will be loaded from repo master file if available
let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}') || {};
let currentPage=1; const pageSize=8;

// Initialize settings with prefill if empty
(function initSettings(){
  if(!settings.owner) settings.owner = PREFILL_OWNER;
  if(!settings.repo) settings.repo = PREFILL_REPO;
  if(!settings.dir) settings.dir = PREFILL_DIR;
  if(!settings.branch) settings.branch = 'main';
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
})();

// UI helpers
function addField(label,id,multi=false, opts){ const container=byId('dynamicFields'); const wrap=document.createElement('div'); wrap.style.marginBottom='8px'; const lab=document.createElement('label'); lab.textContent=label + (opts && opts.required? ' ':''); if(opts && opts.required){ const star=document.createElement('span'); star.className='required'; star.textContent='*'; lab.appendChild(star); } lab.htmlFor=id; wrap.appendChild(lab); let field; if(multi){ field=document.createElement('textarea'); } else if(opts && opts.type==='select'){ field=document.createElement('select'); opts.choices.forEach(ch=>{ const o=document.createElement('option'); o.value=ch; o.textContent=ch; field.appendChild(o); }); } else { field=document.createElement('input'); field.type=(opts && opts.inputType)?opts.inputType:'text'; } field.id=id; wrap.appendChild(field); container.appendChild(wrap); if(opts && opts.info){ const info=document.createElement('span'); info.className='info'; info.textContent=' ℹ️'; info.title=opts.info; lab.appendChild(info); } return field; }

function renderFields(){ const type=byId('scriptType').value; const c=byId('dynamicFields'); c.innerHTML=''; const modeChoices=['delta','full','full_restore']; if(type==='dmsRaw'){ addField('Bucket Name','bucket',false); addField('Key paths (comma separated)','key',true); } else if(type==='recalc'){ addField('Chain Name','chain',false,{required:true}); addField('Source ID','src',false,{required:true}); addField('Table Name','table',false); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='recalcBackup'){ addField('Chain Name','chain',false,{required:true}); addField('Source ID','src',false,{required:true}); addField('Tables with backup_load_id (JSON array)','tables',true,{info:'{\\n  \"table_name\": \"<TABLE_NAME>\",\\n  \"backup_load_id\": \"jr_<loadid>\"\\n}'}); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='dmsTask'){ addField('Action (start/stop)','action',false,{required:true}); addField('Task Names (comma separated)','tasks',true,{required:true,info:'Provide DMS task names comma separated'}); } else if(type==='refine'){ addField('Chain Name','chain',false,{required:true}); addField('Source ID','src',false,{required:true}); addField('Tables (comma separated)','tables',true); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='conform'){ addField('Chain Name','chain',false,{required:true}); addField('Parent ETL Job','parent',false); addField('Source ID','src',false,{required:true}); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='conformTable'){ addField('Chain Name','chain',false,{required:true}); addField('Parent ETL Job','parent',false); addField('Source ID','src',false,{required:true}); addField('Tables (comma separated)','tables',true); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='restore'){ addField('Chain Name','chain',false,{required:true}); addField('Source ID','src',false,{required:true}); addField('DMS Task(s) (comma separated)','tasks',true,{required:true}); addField('Step (1 or 2)','step',false,{type:'select',choices:['1','2'],required:true}); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='refineConform'){ addField('Chain Name','chain',false,{required:true}); addField('Source ID','src',false,{required:true}); addField('Parent ETL Job (Conform)','parent',false); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='datamart'){ addField('Chain Name','chain',false,{required:true}); addField('Parent ETL Job','parent',false); addField('Application Code','app',false); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } else if(type==='datamartEntity'){ addField('Chain Name','chain',false,{required:true}); addField('Parent ETL Job','parent',false); addField('Application Code','app',false); addField('ETL Entities (comma separated)','entities',true); addField('Mode','mode',false,{type:'select',choices:modeChoices,required:true}); addField('Workers','workers',false,{required:true,inputType:'number'}); } }

byId('scriptType').addEventListener('change', renderFields); renderFields();

// Build payload (same as earlier)
function na(v){ return (v===undefined||v===null||v==='')? 'NA' : v; }
function buildPayload(){ const type=byId('scriptType').value; const w = byId('workers')?.value || byId('workers_global')?.value || 'NA'; try{ if(type==='dmsRaw'){ return { bucketName: na(byId('bucket')?.value), keys: byId('key')?.value ? byId('key').value.split(',').map(s=>s.trim()) : [] }; } if(type==='recalc'){ return { launch:'manual', refine:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job:'edb_mq_dia_golden_copy', systems:[{ r_src_id: na(byId('src')?.value), tables:[{ table_name: na(byId('table')?.value) }] }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] } }; } if(type==='recalcBackup'){ let tablesTxt = byId('tables')?.value || '[]'; let tablesArr=[]; try{ tablesArr = JSON.parse(tablesTxt); }catch(e){ tablesArr = []; } return { launch:'manual', refine:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job:'edb_mq_dia_golden_copy', systems:[{ r_src_id: na(byId('src')?.value), tables: tablesArr }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] } }; } if(type==='dmsTask'){ const action = na(byId('action')?.value); const list = byId('tasks')?.value ? byId('tasks').value.split(',').map(s=>s.trim()) : []; return { dms:{ action: action, dms_object:'task', mode:'default', ...(action==='start'?{ start_type:'resume' }:{}), input_list: list } }; } if(type==='refine'){ return { launch:'manual', refine:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job:'edb_mq_dia_golden_copy', systems:[{ r_src_id: na(byId('src')?.value), tables: byId('tables')?.value ? byId('tables').value.split(',').map(s=>s.trim()) : [] }], mode: na(byId('mode')?.value), n_workers: Number(w)||10, free_threads:true }] }] } }; } if(type==='conform'){ return { launch:'manual', conform:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job: na(byId('parent')?.value), systems:[{ r_src_id: na(byId('src')?.value), dependencies: [] }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] } }; } if(type==='conformTable'){ return { launch:'manual', conform:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), parent_etl_job: na(byId('parent')?.value), systems:[{ r_src_id: na(byId('src')?.value), tables: byId('tables')?.value ? byId('tables').value.split(',').map(s=>s.trim()) : [] }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] } }; } if(type==='restore'){ return { launch:'manual', refine:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:false, parent_etl_job:'edb_mq_dia_golden_copy', systems:[{ r_src_id: na(byId('src')?.value), dms_tasks: byId('tasks')?.value ? byId('tasks').value.split(',').map(s=>s.trim()) : [] }], mode: na(byId('mode')?.value), step: na(byId('step')?.value), n_workers: Number(w)||10, free_threads:true }] }] } }; } if(type==='refineConform'){ return { launch:'batch', refine:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job:'edb_mq_dia_golden_copy', systems:[{ r_src_id: na(byId('src')?.value) }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] }, conform:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job: na(byId('parent')?.value), systems:[{ r_src_id: na(byId('src')?.value), dependencies:[] }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] } }; } if(type==='datamart'){ return { launch:'manual', datamart:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job: na(byId('parent')?.value), systems:[{ applctn_cd: na(byId('app')?.value) }], mode: na(byId('mode')?.value), n_workers: Number(w)||10, free_threads:true }] }] } }; } if(type==='datamartEntity'){ const ent = byId('entities')?.value ? byId('entities').value.split(',').map(s=>s.trim()) : []; return { launch:'manual', datamart:{ sequential_jobs:[{ parallel_jobs:[{ chain_name: na(byId('chain')?.value), check_dependency:true, parent_etl_job: na(byId('parent')?.value), systems:[{ applctn_cd: na(byId('app')?.value), etl_entity: ent, dependencies: [] }], mode: na(byId('mode')?.value), n_workers: Number(w)||40, free_threads:true }] }] } }; } }catch(e){ return { error: e.message }; } }

// display & copy
byId('genBtn').addEventListener('click', ()=>{ const p = buildPayload(); byId('output').textContent = JSON.stringify(p,null,2); });
byId('copyBtn').addEventListener('click', ()=>{ const txt = byId('output').textContent; if(!txt){ alert('Nothing to copy'); return;} navigator.clipboard.writeText(txt).then(()=>alert('JSON copied to clipboard')); });
byId('downloadBtn').addEventListener('click', ()=>{ const txt = byId('output').textContent || ''; const blob = new Blob([txt], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'payload.json'; a.click(); URL.revokeObjectURL(a.href); });

// Modal & approval submission
const modal = byId('modalBackdrop');
byId('reqBtn').addEventListener('click', ()=>{ modal.style.display='flex'; byId('modalRequestor').value=''; byId('modalApprover').value=''; byId('modalTicket').value=''; byId('modalReason').value=''; });
byId('closeModal').addEventListener('click', ()=> modal.style.display='none');
byId('cancelRequest').addEventListener('click', ()=> modal.style.display='none');

// GitHub API helpers
function ghHeaders(){ return { 'Authorization': 'token '+(settings.token||''), 'Accept': 'application/vnd.github.v3+json' }; }
async function ghGetFile(path){
  const owner = settings.owner || PREFILL_OWNER;
  const repo = settings.repo || PREFILL_REPO;
  const branch = settings.branch || 'main';
  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
  const res = await fetch(url, { headers: ghHeaders() });
  if(res.status===404) return null;
  if(!res.ok) throw new Error('GitHub GET failed: '+(await res.text()));
  const j = await res.json();
  return j; // contains content (base64), sha, etc
}
async function ghPutFile(path, contentBase64, message, sha=null){
  const owner = settings.owner || PREFILL_OWNER;
  const repo = settings.repo || PREFILL_REPO;
  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: contentBase64, branch: settings.branch || 'main' };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers: ghHeaders(), body: JSON.stringify(body) });
  if(!res.ok) throw new Error('GitHub PUT failed: '+(await res.text()));
  return await res.json();
}

// load master approvals from repo into app (shared state)
async function loadApprovalsFromRepo(){
  try{
    const path = (settings.dir || PREFILL_DIR).replace(/\/+$/,'') + '/' + MASTER_FILENAME;
    const file = await ghGetFile(path);
    if(!file){ // create empty master file
      approvals = [];
      await saveApprovalsToRepo(approvals, 'Create master approvals file');
      renderTable();
      return;
    }
    const raw = atob(file.content.replace(/\n/g,''));
    approvals = JSON.parse(raw || '[]');
    saveLocal(); renderTable();
  }catch(err){
    console.warn('Could not load approvals from repo, falling back to localStorage. Error:', err.message);
    // fallback to local stored copy if exists
    const local = localStorage.getItem(STORAGE_KEY);
    approvals = local ? JSON.parse(local) : [];
    renderTable();
  }
}

// save approvals to repo MASTER file (overwrites)
async function saveApprovalsToRepo(arr, message){
  if(!settings.token){ throw new Error('No GitHub token in Settings'); }
  const path = (settings.dir || PREFILL_DIR).replace(/\/+$/,'') + '/' + MASTER_FILENAME;
  // get sha if exists
  let sha = null;
  try{ const existing = await ghGetFile(path); if(existing) sha = existing.sha; }catch(e){ /*ignore*/ }
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(arr, null, 2))));
  await ghPutFile(path, content, message || 'Update approvals master', sha);
}

// export backup (csv + json) and reset approvals in repo
async function exportAndResetToRepo(){
  if(!settings.token){ throw new Error('No GitHub token in Settings'); }
  if(approvals.length===0) return { csvPath:null, jsonPath:null };
  const date = new Date().toISOString().slice(0,10);
  const dir = (settings.dir || PREFILL_DIR).replace(/\/+$/,'');
  // build CSV
  const rows = [['Req ID','Requestor','Approver','Chain','Src','Mode','Step','Ticket','Reason','Requested Time','Approval Time','Status']];
  approvals.forEach(a=> rows.push([a.id,a.requestor,a.approver,a.chain,a.src,a.mode,a.step||'NA',a.ticket,a.reason,new Date(a.requestedTime).toLocaleString(), a.approvalTime?new Date(a.approvalTime).toLocaleString():'', a.status]));
  const csv = rows.map(r=>r.map(c=>'"'+String(c??'').replace(/"/g,'""')+'"').join(',')).join('\n');
  // upload csv
  const csvB64 = btoa(unescape(encodeURIComponent(csv)));
  const csvPath = `${dir}/approvals_${date}.csv`;
  await ghPutFile(csvPath, csvB64, `Export approvals CSV ${date}`);
  // upload json
  const jsonB64 = btoa(unescape(encodeURIComponent(JSON.stringify(approvals, null, 2))));
  const jsonPath = `${dir}/approvals_${date}.json`;
  await ghPutFile(jsonPath, jsonB64, `Export approvals JSON ${date}`);
  // reset master to empty
  approvals = [];
  await saveApprovalsToRepo(approvals, `Reset approvals after export ${date}`);
  saveLocal();
  renderTable();
  return { csvPath, jsonPath };
}

// save local copy (localStorage) as fallback & for offline
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(approvals)); localStorage.setItem(RESET_KEY, localStorage.getItem(RESET_KEY) || new Date().toISOString()); localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

// Auto export runner (on load)
async function autoExportRunner(){
  try{
    const last = localStorage.getItem(RESET_KEY);
    if(!last){ localStorage.setItem(RESET_KEY, new Date().toISOString()); return; }
    const lastDate = new Date(last);
    const diffDays = (Date.now() - lastDate.getTime())/(1000*60*60*24);
    if(diffDays < RESET_DAYS) return;
    if(approvals.length===0){ localStorage.setItem(RESET_KEY, new Date().toISOString()); return; }
    // Prefer export to repo if token configured
    if(settings.token){
      await exportAndResetToRepo();
      localStorage.setItem(RESET_KEY, new Date().toISOString());
      alert('Auto-exported approvals to GitHub Export_Data/ and reset local data.');
    } else {
      // fallback: download locally and reset master in repo if token present? skip repo and local download then reset local storage only
      const csv = approvals.map(a=>[a.id,a.requestor,a.approver,a.chain,a.src,a.mode,a.step||'NA',a.ticket,a.reason,new Date(a.requestedTime).toLocaleString(), a.approvalTime?new Date(a.approvalTime).toLocaleString():'', a.status].map(c=>'"'+String(c??'')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'approvals_export_'+new Date().toISOString().slice(0,10)+'.csv'; document.body.appendChild(a); a.click(); a.remove();
      // reset local only
      approvals=[]; saveLocal(); localStorage.setItem(RESET_KEY, new Date().toISOString());
      alert('Auto-exported approvals to local CSV and reset data (no GitHub token configured).');
    }
  }catch(err){
    console.error('Auto export failed', err);
  }
}

// CRUD + UI for approvals
function renderTable(){ const tbody = byId('approvalTable').querySelector('tbody'); tbody.innerHTML=''; const search = byId('searchInput').value.toLowerCase(); const dateFilter = byId('filterDate').value; const status = byId('statusFilter').value; const filtered = approvals.filter(a=>{ const matchSearch = (a.chain+' '+a.src+' '+a.mode+' '+(a.ticket||'')+' '+a.requestor+' '+a.approver).toLowerCase().includes(search); const matchDate = dateFilter? new Date(a.requestedTime).toISOString().split('T')[0]===dateFilter : true; const matchStatus = status? a.status===status : true; return matchSearch && matchDate && matchStatus; }); const totalPages=Math.max(1,Math.ceil(filtered.length/pageSize)); if(currentPage>totalPages) currentPage=1; const start=(currentPage-1)*pageSize; const pageData = filtered.slice(start,start+pageSize); pageData.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td class="smaller">${a.id}</td><td class="smaller">${a.requestor}</td><td class="smaller">${a.approver}</td><td class="smaller">${a.chain}</td><td class="smaller">${a.src}</td><td class="smaller">${a.mode}</td><td class="smaller">${a.step||'NA'}</td><td class="smaller">${a.ticket}</td><td class="smaller">${a.reason}</td><td class="smaller">${new Date(a.requestedTime).toLocaleString()}</td><td class="smaller">${a.approvalTime?new Date(a.approvalTime).toLocaleString():'NA'}</td><td class="smaller"><span class="status ${a.status}">${a.status}</span></td><td class="smaller"><button class="pagebtn" onclick="approveRequest('${a.id}')">Approve</button> <button class="pagebtn" onclick="rejectRequest('${a.id}')">Reject</button></td>`; tbody.appendChild(tr); }); // pagination render
  const pag = byId('pagination'); pag.innerHTML=''; const total = filtered.length; const totalP = Math.max(1, Math.ceil(total/pageSize)); for(let i=1;i<=totalP;i++){ const b=document.createElement('button'); b.textContent=i; b.className='pagebtn'; if(i===currentPage) b.style.background='#eef2ff'; b.onclick=(()=>{ const page=i; return ()=>{ currentPage=page; renderTable(); }; })(); pag.appendChild(b); } }

async function persistApprovals(message){ try{ saveLocal(); if(settings.token){ await saveApprovalsToRepo(approvals, message||'Update approvals'); } }catch(e){ console.warn('Persist to repo failed:', e.message); } }

// Submit request handler
byId('submitRequest').addEventListener('click', async ()=>{
  const req = byId('modalRequestor').value.trim(); const app = byId('modalApprover').value.trim(); const ticket = byId('modalTicket').value.trim(); const reason = byId('modalReason').value.trim();
  if(!req || !app || !ticket || !reason){ alert('Please fill all required fields in the request modal.'); return; }
  const payload = (()=>{ try{ return JSON.parse(byId('output').textContent); }catch(e){ return buildPayload(); } })();
  const id = 'REQ-'+Math.floor(Math.random()*900000+100000);
  const requestedTime = new Date().toISOString();
  const meta = (()=>{ try{ return { chain: payload.refine?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.chain_name || payload.conform?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.chain_name || payload.datamart?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.chain_name || 'NA', src: payload.refine?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.systems?.[0]?.r_src_id || payload.conform?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.systems?.[0]?.r_src_id || 'NA', mode: payload.refine?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.mode || payload.conform?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.mode || payload.datamart?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.mode || 'NA' }; }catch(e){ return {chain:'NA',src:'NA',mode:'NA'} } })();
  const stepVal = payload.refine?.sequential_jobs?.[0]?.parallel_jobs?.[0]?.step || 'NA';
  const rec = { id, requestor: req, approver: app, chain: meta.chain||'NA', src: meta.src||'NA', mode: meta.mode||'NA', step: stepVal, ticket, reason, requestedTime, approvalTime: null, status:'Pending', payload };
  approvals.unshift(rec);
  await persistApprovals('New approval request '+id);
  modal.style.display='none'; renderTable(); alert('Request submitted: '+id);
});

// Approve / Reject
async function approveRequest(id){ const idx = approvals.findIndex(x=>x.id===id); if(idx>-1){ approvals[idx].status='Approved'; approvals[idx].approvalTime = new Date().toISOString(); await persistApprovals('Approve '+id); renderTable(); alert('Approved '+id); } }
async function rejectRequest(id){ const idx = approvals.findIndex(x=>x.id===id); if(idx>-1){ const reason = prompt('Reason for rejection (optional)'); approvals[idx].status='Rejected'; approvals[idx].approvalTime = new Date().toISOString(); if(reason) approvals[idx].rejectReason = reason; await persistApprovals('Reject '+id); renderTable(); alert('Rejected '+id); } }

// Settings modal actions
byId('openSettings').addEventListener('click', ()=>{ byId('settingsBackdrop').style.display='flex'; byId('ghOwner').value = settings.owner || PREFILL_OWNER; byId('ghRepo').value = settings.repo || PREFILL_REPO; byId('ghBranch').value = settings.branch || 'main'; byId('ghDir').value = settings.dir || PREFILL_DIR; byId('ghToken').value = settings.token || ''; });
byId('closeSettings').addEventListener('click', ()=> byId('settingsBackdrop').style.display='none');
byId('saveSettings').addEventListener('click', ()=>{ settings.owner = byId('ghOwner').value.trim(); settings.repo = byId('ghRepo').value.trim(); settings.branch = byId('ghBranch').value.trim()||'main'; settings.dir = byId('ghDir').value.trim()||PREFILL_DIR; settings.token = byId('ghToken').value.trim(); localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); byId('settingsBackdrop').style.display='none'; alert('Settings saved locally.'); });

// Manual export button not shown in UI; auto-run on load and provide a button via console if needed
// GitHub file PUT wrapper reused above

// Load on start: try to load master from repo, else fallback to local
(async function start(){
  // load settings from localStorage if present
  const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}'); if(s) settings = s;
  // Try to load approvals from repo master file (shared state)
  await loadApprovalsFromRepo();
  // run auto export if due
  await autoExportRunner();
  // attach filters and events
  byId('searchInput').addEventListener('input', ()=>{ currentPage=1; renderTable(); });
  byId('filterDate').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
  byId('statusFilter').addEventListener('change', ()=>{ currentPage=1; renderTable(); });
  byId('workers_global').addEventListener('change', ()=>{ if(byId('workers')) byId('workers').value = byId('workers_global').value; });
})();

</script>

<div>
    <h2>Submit a Request</h2>
    <input type="text" id="nameInput" placeholder="Your Name" />
    <input type="text" id="messageInput" placeholder="Your Request" />
    <button onclick="submitRequest()">Submit</button>
</div>
<div>
    <h2>Request List</h2>
    <div id="requestList"></div>
</div>

<script>
// ======================= CONFIGURATION =========================
// Replace these values with your actual GitHub repo details
const GITHUB_OWNER = "fareed-007";
const GITHUB_REPO = "dia-gmdf-webapp-tool";
const FILE_PATH = "requests.json";
const GITHUB_TOKEN = "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"; // Replace with your actual token

// ======================= GLOBAL VARIABLES ======================
let currentSha = ""; // SHA of the current file version
let requests = [];   // Array to hold request data

// ======================= LOAD REQUESTS =========================
async function loadRequests() {
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`;
    const response = await fetch(url, {
        headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github.v3.raw"
        }
    });

    if (response.ok) {
        requests = await response.json();
        displayRequests();
        const metaResponse = await fetch(url, {
            headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                Accept: "application/vnd.github.v3+json"
            }
        });
        const metaData = await metaResponse.json();
        currentSha = metaData.sha;
    } else {
        console.error("Failed to load requests.json");
    }
}

// ======================= DISPLAY REQUESTS ======================
function displayRequests() {
    const container = document.getElementById("requestList");
    container.innerHTML = "";
    requests.forEach((req, index) => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${req.name}</strong>: ${req.message}`;
        container.appendChild(div);
    });
}

// ======================= SUBMIT REQUEST ========================
async function submitRequest() {
    const name = document.getElementById("nameInput").value;
    const message = document.getElementById("messageInput").value;
    if (!name || !message) return alert("Please fill all fields");

    requests.push({ name, message });

    const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(requests, null, 2))));
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`;
    const response = await fetch(url, {
        method: "PUT",
        headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
            message: "Add new request",
            content: updatedContent,
            sha: currentSha
        })
    });

    if (response.ok) {
        alert("Request submitted successfully!");
        loadRequests();
    } else {
        alert("Failed to submit request.");
    }
}

// ======================= INITIALIZE ============================
window.onload = loadRequests;
</script>

</body>
</html>

